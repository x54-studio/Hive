// src/__tests__/ArticleActions.test.js
import React from "react";
import { render, screen, waitFor, cleanup } from "@testing-library/react";
import Home from "../../pages/Home";
import { Provider } from "react-redux";
import { combineReducers, configureStore } from "@reduxjs/toolkit";
import authReducer from "../../redux/authSlice";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";

// Combine our auth reducer.
const rootReducer = combineReducers({
  auth: authReducer,
});

// Helper function to create a test Redux store.
const createTestStore = (preloadedState) =>
  configureStore({
    reducer: rootReducer,
    preloadedState,
  });

// Create a test-specific QueryClient.
const createTestQueryClient = () =>
  new QueryClient({
    defaultOptions: {
      queries: {
        retry: false,
        cacheTime: 0,
        refetchOnMount: true,
        enabled: true,
      },
    },
  });

// Helper function to render components with Redux and QueryClient providers.
const renderWithProviders = (ui, { preloadedState } = {}) => {
  const store = createTestStore(preloadedState);
  const queryClient = createTestQueryClient();
  return render(
    <Provider store={store}>
      <QueryClientProvider client={queryClient}>{ui}</QueryClientProvider>
    </Provider>
  );
};

describe("Article Actions - Admin User", () => {
  beforeEach(() => {
    // Mock fetch to return a single article.
    global.fetch = jest.fn(() =>
      Promise.resolve({
        ok: true,
        json: async () => [
          { _id: "1", title: "Article 1", content: "Content 1" }
        ],
      })
    );
  });

  afterEach(() => {
    cleanup();
    jest.resetAllMocks();
  });

  test("renders AddArticle component for admin users", async () => {
    // Preloaded state for an admin user.
    renderWithProviders(<Home />, {
      preloadedState: {
        auth: {
          user: { username: "adminUser", claims: { role: "admin" } },
        },
      },
    });

    // Wait for the article to load.
    await waitFor(() => {
      expect(screen.getByText(/Article 1/i)).toBeInTheDocument();
    });
    // Admin users should see the AddArticle section.
    expect(screen.getByText(/Add New Article/i)).toBeInTheDocument();
  });

  test("renders delete button in ArticleList for admin users", async () => {
    renderWithProviders(<Home />, {
      preloadedState: {
        auth: {
          user: { username: "adminUser", claims: { role: "admin" } },
        },
      },
    });
    await waitFor(() => {
      expect(screen.getByText(/Article 1/i)).toBeInTheDocument();
    });
    // Admin users should see the Delete button.
    expect(screen.getByText("Delete")).toBeInTheDocument();
  });
});

describe("Article Actions - Regular User", () => {
  beforeEach(() => {
    global.fetch = jest.fn(() =>
      Promise.resolve({
        ok: true,
        json: async () => [
          { _id: "1", title: "Article 1", content: "Content 1" }
        ],
      })
    );
  });

  afterEach(() => {
    cleanup();
    jest.resetAllMocks();
  });

  test("does not render AddArticle component for regular users", async () => {
    // Preloaded state for a regular user.
    renderWithProviders(<Home />, {
      preloadedState: {
        auth: {
          user: { username: "regularUser", claims: { role: "regular" } },
        },
      },
    });
    await waitFor(() => {
      expect(screen.getByText(/Article 1/i)).toBeInTheDocument();
    });
    // Regular users should NOT see the AddArticle section.
    expect(screen.queryByText(/Add New Article/i)).toBeNull();
  });

  test("does not render delete button in ArticleList for regular users", async () => {
    renderWithProviders(<Home />, {
      preloadedState: {
        auth: {
          user: { username: "regularUser", claims: { role: "regular" } },
        },
      },
    });
    await waitFor(() => {
      expect(screen.getByText(/Article 1/i)).toBeInTheDocument();
    });
    // Regular users should NOT see the Delete button.
    expect(screen.queryByText("Delete")).toBeNull();
  });
});
