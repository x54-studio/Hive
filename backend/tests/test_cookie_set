import unittest
from app import create_app
import json


class TestCookieSet(unittest.TestCase):

    def setUp(self):
        self.app = create_app()
        self.app.config["TESTING"] = True
        self.client = self.app.test_client()

    def test_login_sets_cookies(self):
        # First, register a user if required
        register_data = {
            "username": "cookieuser",
            "email": "cookieuser@example.com",
            "password": "testpassword"
        }
        self.client.post("/api/register", json=register_data)

        # Then, login the user
        login_data = {
            "email": "cookieuser@example.com",
            "password": "testpassword"
        }
        response = self.client.post("/api/login", json=login_data)
        
        # Check that the cookies are set in the response headers.
        # Flask test_client stores cookies in response.headers as 'Set-Cookie'
        set_cookie = response.headers.get("Set-Cookie")
        self.assertIsNotNone(set_cookie)
        self.assertIn("access_token=", set_cookie)
        self.assertIn("refresh_token=", set_cookie)

        # Optionally, inspect the cookie jar on the client:
        cookies = self.client.cookie_jar
        access_token_cookie = None
        refresh_token_cookie = None
        for cookie in cookies:
            if cookie.name == "access_token":
                access_token_cookie = cookie
            if cookie.name == "refresh_token":
                refresh_token_cookie = cookie
        self.assertIsNotNone(access_token_cookie)
        self.assertIsNotNone(refresh_token_cookie)


if __name__ == '__main__':
    unittest.main()
